---
name: 语音平台前后端算法部署
overview: 构建情感人格化语音平台的核心前后端系统与算法部署方案，支持音频上传、音色复刻（StepFun API）、embedding生成（临时随机向量）和TTS生成功能
todos:
  - id: frontend-setup
    content: 搭建前端项目（React + TypeScript + Vite）
    status: completed
  - id: backend-setup
    content: 搭建后端项目（Node.js/Express 或 Python/FastAPI）
    status: completed
  - id: database-setup
    content: 设计并创建数据库表结构（users, files, voices, embeddings, tts_requests）
    status: completed
  - id: file-service
    content: 实现文件上传服务（格式校验、存储、元数据管理）
    status: completed
    dependencies:
      - backend-setup
  - id: embedding-service
    content: 实现临时embedding生成服务（随机向量 + 哈希）
    status: completed
    dependencies:
      - backend-setup
  - id: stepfun-integration
    content: 实现StepFun API集成服务（复刻音色、TTS生成）
    status: completed
    dependencies:
      - backend-setup
  - id: voice-service
    content: 实现角色服务（创建、查询、管理Voice）
    status: completed
    dependencies:
      - file-service
      - embedding-service
      - stepfun-integration
  - id: audio-upload-ui
    content: 实现前端音频上传/录音组件（格式校验、波形可视化）
    status: completed
    dependencies:
      - frontend-setup
  - id: voice-creation-ui
    content: 实现角色创建页面（上传 → 生成 → 试听完整流程）
    status: completed
    dependencies:
      - audio-upload-ui
      - voice-service
  - id: tts-generation-ui
    content: 实现TTS生成页面（文本输入、Voice选择、音频播放）
    status: completed
    dependencies:
      - frontend-setup
      - stepfun-integration
  - id: audio-preprocessing
    content: 实现音频预处理模块（格式转换、采样率统一、时长校验）
    status: completed
    dependencies:
      - backend-setup
  - id: deployment-config
    content: 配置Docker Compose开发环境和生产部署方案
    status: completed
    dependencies:
      - backend-setup
      - frontend-setup
---

# 情感人格化语音平台：前后端与算法部署计划

## 项目概述

构建一个情感人格化语音平台，用户可以上传音频（5-10秒）创建独特的语音角色，通过StepFun API进行音色复刻和TTS生成。第一阶段使用随机向量作为embedding占位，后续可替换为真实codec模型。

## 系统架构

```mermaid
flowchart TB
    subgraph frontend[前端应用]
        UI[Web界面]
        Upload[音频上传/录音]
        VoiceMgmt[角色管理]
        TTSGen[TTS生成]
    end
    
    subgraph backend[后端服务]
        API[API网关]
        FileSvc[文件服务]
        VoiceSvc[角色服务]
        EmbedSvc[Embedding服务]
        StepFunSvc[StepFun集成]
    end
    
    subgraph algorithm[算法服务]
        Preprocess[音频预处理]
        EmbedGen[Embedding生成<br/>临时随机向量]
    end
    
    subgraph storage[存储层]
        DB[(数据库)]
        ObjectStore[对象存储]
        Cache[(Redis缓存)]
    end
    
    subgraph external[外部服务]
        StepFunAPI[StepFun API]
    end
    
    UI --> API
    Upload --> FileSvc
    VoiceMgmt --> VoiceSvc
    TTSGen --> StepFunSvc
    
    API --> FileSvc
    API --> VoiceSvc
    API --> EmbedSvc
    API --> StepFunSvc
    
    FileSvc --> Preprocess
    Preprocess --> EmbedGen
    EmbedGen --> EmbedSvc
    
    VoiceSvc --> StepFunSvc
    StepFunSvc --> StepFunAPI
    
    FileSvc --> ObjectStore
    VoiceSvc --> DB
    EmbedSvc --> DB
    API --> Cache
```

## 前端开发计划

### 技术栈

- **框架**: React + TypeScript + Vite（或 Next.js）
- **UI库**: Ant Design / Material-UI / Tailwind CSS
- **状态管理**: Zustand / Redux Toolkit
- **HTTP客户端**: Axios
- **音频处理**: Web Audio API / wavesurfer.js

### 核心页面与功能

#### 1. 主页/发现页 (`/`)

- 角色列表展示（卡片式布局）
- 搜索与筛选功能
- 热门角色推荐
- 试听播放器（内嵌）

#### 2. 创建角色页 (`/create`)

- **音频上传模块**
  - 文件选择器（支持mp3/wav）
  - 实时录音功能（Web Audio API）
  - 音频波形可视化
  - 时长校验（5-10秒提示）
  - 格式校验与错误提示

- **文本输入模块**
  - 音频对应文本输入（可选，建议提示）
  - 试听文本输入（可选，最多50字）
  - 模型选择（step-tts-2/step-tts-mini/step-tts-vivid/step-audio-2）

- **提交与进度**
  - 上传进度条
  - 处理状态（上传中 → 生成embedding → 复刻音色 → 完成）
  - 错误提示与重试

#### 3. 角色详情页 (`/voices/:id`)

- 角色信息展示
  - Voice ID
  - 创建时间
  - 模型信息
  - 元数据（如创作者、描述）
- 试听音频播放器
  - Base64音频解码播放
  - 播放控制（播放/暂停/下载）
- 使用统计（调用次数等）

#### 4. TTS生成页 (`/tts`)

- 文本输入框
- Voice选择器（下拉/搜索）
- 模型选择
- 生成按钮
- 结果展示
  - 音频播放器
  - 下载链接
  - 生成时间戳

#### 5. 我的角色页 (`/my-voices`)

- 用户创建的角色列表
- 编辑/删除功能
- 使用统计

### 前端关键实现

#### 音频上传组件

```typescript
// 文件上传校验
- 格式检查: ['audio/mpeg', 'audio/wav', 'audio/mp3']
- 大小限制: 建议10MB以内
- 时长检查: 5-10秒（客户端预检查）
- 采样率提示: 建议16kHz/22.05kHz
```

#### 录音功能

```typescript
// Web Audio API录音
- 获取麦克风权限
- 实时录音（MediaRecorder API）
- 波形可视化
- 录音时长限制（5-10秒）
- 格式转换（Blob → File）
```

#### API调用封装

```typescript
// 统一错误处理
- 网络错误重试（指数退避）
- StepFun API错误映射（invalid_api_key等）
- 重复创建处理（duplicated字段）
- 加载状态管理
```

## 后端开发计划

### 技术栈

- **框架**: Node.js + Express/NestJS 或 Python + FastAPI
- **数据库**: PostgreSQL（主库）+ Redis（缓存）
- **对象存储**: 本地文件系统 / MinIO / 云存储（OSS/S3）
- **任务队列**: BullMQ（Node.js）或 Celery（Python）
- **文件处理**: multer（Node.js）或 python-multipart

### 核心服务模块

#### 1. 文件服务 (`FileService`)

**职责**: 处理音频文件上传、存储、格式转换

**API端点**:

- `POST /api/files/upload` - 上传音频文件
  - 接收multipart/form-data
  - 校验格式（mp3/wav）、大小、时长
  - 保存到对象存储
  - 返回fileId和文件元数据

- `GET /api/files/:fileId` - 获取文件信息/下载链接
- `DELETE /api/files/:fileId` - 删除文件

**实现要点**:

- 文件存储路径: `uploads/{userId}/{timestamp}_{filename}`
- 文件元数据存储: 文件名、大小、格式、时长、上传时间
- 支持代理上传到StepFun（获取stepFileId）

#### 2. Embedding服务 (`EmbeddingService`)

**职责**: 生成音频embedding向量（第一阶段使用随机向量）

**API端点**:

- `POST /api/embeddings/generate` - 生成embedding
  - 输入: fileId
  - 输出: embedding向量（256/512维）、向量哈希

**实现要点**:

- **临时实现**: 固定维度随机向量（如256维）
  - 使用可复现种子（基于fileId哈希）
  - 生成向量哈希（SHA256）用于唯一标识
- **预留接口**: 后续可替换为真实codec模型
  - 调用算法服务的HTTP/gRPC接口
  - 支持模型版本管理

#### 3. 角色服务 (`VoiceService`)

**职责**: 管理语音角色（Voice）的创建、查询、更新

**API端点**:

- `POST /api/voices` - 创建音色角色
  - 输入: fileId, text（可选）, sample_text（可选）, model
  - 流程: 

    1. 生成embedding
    2. 调用StepFun `/v1/audio/voices` 复刻音色
    3. 保存voiceId、sample音频、元数据

  - 输出: voiceId, sample_audio（base64）, embedding_hash

- `GET /api/voices/:voiceId` - 查询角色详情
- `GET /api/voices` - 列表查询（支持分页、搜索）
- `PUT /api/voices/:voiceId` - 更新角色元数据
- `DELETE /api/voices/:voiceId` - 删除角色

**实现要点**:

- 幂等性处理: 检查是否已创建（基于fileId+model）
- 重复创建: 返回duplicated=true，复用已有voiceId
- 样本音频存储: 保存base64解码后的wav文件

#### 4. StepFun集成服务 (`StepFunService`)

**职责**: 封装StepFun API调用

**核心方法**:

```typescript
// 复刻音色
async cloneVoice(fileId: string, model: string, text?: string, sampleText?: string)
  → 调用 POST https://api.stepfun.com/v1/audio/voices
  → 返回: { id, sample_audio, duplicated }

// 生成TTS
async generateSpeech(input: string, voice: string, model: string)
  → 调用 POST https://api.stepfun.com/v1/audio/speech
  → 返回: 音频流/文件
```

**实现要点**:

- API密钥管理: 环境变量 `STEP_API_KEY`，不在日志中暴露
- 错误处理:
  - `invalid_api_key`: 立即告警，禁止重试
  - 限流: 指数退避重试
  - 超时: 设置合理超时时间（30s）
- 请求日志: 记录请求/响应（脱敏处理）
- 熔断保护: 外部API失败率过高时熔断

#### 5. TTS生成服务 (`TTSService`)

**职责**: 处理TTS生成请求

**API端点**:

- `POST /api/tts/generate` - 生成TTS音频
  - 输入: voiceId, input（文本）, model
  - 流程:

    1. 查询voiceId获取StepFun voice
    2. 调用StepFun `/v1/audio/speech`
    3. 保存生成的音频文件
    4. 记录使用量

  - 输出: 音频文件URL或base64

**实现要点**:

- 使用量记录: 记录调用次数、生成时长
- 音频存储: `tts_outputs/{voiceId}/{timestamp}.mp3`
- 缓存策略: 相同文本+voice可缓存（可选）

### 数据库设计

#### 核心表结构

**users** - 用户表

```sql
id, email, created_at, updated_at
```

**files** - 文件表

```sql
id, user_id, filename, file_path, file_size, duration, format, 
step_file_id, created_at
```

**voices** - 角色表

```sql
id, user_id, step_voice_id, file_id, model, text, sample_text,
sample_audio_path, embedding_hash, metadata (JSON),
created_at, updated_at
```

**embeddings** - Embedding表

```sql
id, file_id, vector (数组/JSON), vector_hash, dimension,
model_version, created_at
```

**tts_requests** - TTS请求记录

```sql
id, user_id, voice_id, input_text, model, audio_path,
duration, created_at
```

### API设计规范

**统一响应格式**:

```json
{
  "success": true,
  "data": {},
  "message": "",
  "error": null
}
```

**错误码**:

- 400: 请求参数错误
- 401: 未授权
- 404: 资源不存在
- 429: 限流
- 500: 服务器错误
- 502: 外部API错误

## 算法部署计划

### 阶段一：临时Embedding生成（占位实现）

#### 音频预处理模块

**输入**: 音频文件（mp3/wav，5-10秒）

**输出**: 预处理后的音频数据

**处理流程**:

1. **格式转换**: 统一转换为wav格式
2. **采样率统一**: 转换为16kHz或22.05kHz
3. **声道处理**: 转为单声道（mono）
4. **时长校验**: 确保在5-10秒范围内
5. **音频归一化**: 音量标准化

**技术实现**:

- Node.js: 使用 `ffmpeg` 命令行工具或 `fluent-ffmpeg` 库
- Python: 使用 `librosa` 或 `pydub` + `ffmpeg`

#### 随机向量生成模块

**输入**: 预处理后的音频文件ID

**输出**: 固定维度embedding向量 + 哈希

**实现逻辑**:

```python
# 伪代码示例
def generate_random_embedding(file_id: str, dimension: int = 256):
    # 使用fileId作为种子，确保可复现
    seed = hash(file_id) % (2**32)
    np.random.seed(seed)
    
    # 生成随机向量
    vector = np.random.normal(0, 1, dimension)
    
    # 归一化
    vector = vector / np.linalg.norm(vector)
    
    # 生成哈希
    vector_hash = sha256(vector.tobytes()).hexdigest()
    
    return vector, vector_hash
```

**部署方式**:

- **方案A**: 作为后端服务的一部分（同步调用）
- **方案B**: 独立微服务（HTTP/gRPC接口）

### 阶段二：真实Codec模型接入（后续）

#### 模型选择

- **Speaker Embedding**: ECAPA-TDNN, Resemblyzer
- **Neural Codec**: EnCodec, Neural Audio Codec

#### 部署架构

```mermaid
flowchart LR
    Backend[后端服务] -->|HTTP/gRPC| ModelService[模型推理服务]
    ModelService -->|加载| Model[模型权重]
    ModelService -->|GPU加速| GPU[GPU资源]
```

**部署要求**:

- **容器化**: Docker + Docker Compose
- **推理服务**: 
  - Python: FastAPI + PyTorch/TensorFlow
  - 或使用 TorchServe / TensorFlow Serving
- **资源配置**:
  - CPU模式: 4核+，8GB内存
  - GPU模式: CUDA支持，显存4GB+
- **接口设计**:
  - 输入: 音频文件路径或base64
  - 输出: embedding向量（JSON）

**版本管理**:

- 模型版本号（v1, v2...）
- 支持A/B测试
- 平滑切换机制

## 部署与运维

### 开发环境

- **本地开发**: Docker Compose一键启动
  - 前端: Vite dev server (端口3000)
  - 后端: Express/FastAPI (端口8000)
  - 数据库: PostgreSQL (端口5432)
  - Redis: (端口6379)
  - MinIO: 对象存储 (端口9000)

### 生产环境

- **容器化部署**: Docker + Kubernetes（可选）
- **反向代理**: Nginx
- **进程管理**: PM2（Node.js）或 Gunicorn（Python）
- **监控**: 
  - 日志: Winston/Pino（Node.js）或 Loguru（Python）
  - 指标: Prometheus + Grafana
  - 错误追踪: Sentry

### 环境变量配置

```bash
# StepFun API
STEP_API_KEY=your_api_key

# 数据库
DATABASE_URL=postgresql://user:pass@localhost:5432/voice_platform
REDIS_URL=redis://localhost:6379

# 对象存储
STORAGE_TYPE=local|minio|oss
STORAGE_PATH=/data/uploads

# 算法服务
EMBEDDING_SERVICE_URL=http://localhost:8001
EMBEDDING_DIMENSION=256
```

## 测试计划

### 单元测试

- 文件上传校验
- Embedding生成（随机向量）
- StepFun API封装
- 错误处理逻辑

### 集成测试

- 完整流程: 上传 → 生成embedding → 复刻音色 → TTS生成
- StepFun API集成测试（Mock或测试环境）
- 数据库操作测试

### 端到端测试

- 前端 → 后端 → StepFun完整链路
- 异常场景: API密钥错误、限流、网络超时

## 开发里程碑

### M0: 核心功能原型（2-3周）

- [ ] 前端: 音频上传/录音、基础UI
- [ ] 后端: 文件服务、StepFun集成
- [ ] 算法: 随机embedding生成
- [ ] 功能: 音色复刻、TTS生成

### M1: 完善与优化（1-2周）

- [ ] 前端: 角色管理、列表展示、试听播放
- [ ] 后端: 完整的CRUD、使用量统计
- [ ] 优化: 错误处理、性能优化

### M2: 真实模型接入（后续）

- [ ] 算法: 接入真实codec/embedding模型
- [ ] 部署: 模型服务容器化
- [ ] 性能: 推理速度优化

## 关键技术决策

1. **前后端分离**: RESTful API，前端独立部署
2. **文件存储**: 初期本地/MinIO，后续可迁移云存储
3. **Embedding占位**: 随机向量 + 可复现种子，便于后续替换
4. **StepFun集成**: 统一封装，便于后续切换其他TTS服务
5. **错误处理**: 统一错误码，友好错误提示

## 风险与应对

1. **StepFun API限流**: 实现请求队列、重试机制、熔断保护
2. **音频处理性能**: 异步任务队列、批量处理
3. **存储空间**: 定期清理、生命周期管理
4. **API密钥安全**: 环境变量、密钥轮换机制